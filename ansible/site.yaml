---
############################
# COMMON â€“ ALL NODES
############################
- name: Common setup on all nodes
  hosts: all
  become: true
  tasks:
    - name: Disable swap (runtime)
      command: swapoff -a
      changed_when: false
      failed_when: false

    - name: Disable swap (fstab)
      replace:
        path: /etc/fstab
        regexp: '^(\s*[^#]\S+\s+\S+\s+swap\s+\S+.*)$'
        replace: '# \1'

    - name: Load kernel modules
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter

    - name: modprobe kernel modules
      shell: |
        modprobe overlay
        modprobe br_netfilter
      args:
        executable: /bin/bash
      changed_when: false

    - name: Sysctl for Kubernetes
      copy:
        dest: /etc/sysctl.d/k8s.conf
        content: |
          net.bridge.bridge-nf-call-iptables  = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward                 = 1

    - name: Apply sysctl
      command: sysctl --system
      changed_when: false

    - name: Install base packages
      apt:
        update_cache: true
        name:
          - curl
          - ca-certificates
          - gpg
          - apt-transport-https
        state: present

    - name: Install containerd and CNI plugins
      apt:
        name:
          - containerd
          - containernetworking-plugins
        state: present

    - name: Generate default containerd config if missing
      shell: |
        mkdir -p /etc/containerd
        test -f /etc/containerd/config.toml || (containerd config default | tee /etc/containerd/config.toml >/dev/null)
      args:
        executable: /bin/bash

    - name: Configure containerd (SystemdCgroup)
      replace:
        path: /etc/containerd/config.toml
        regexp: 'SystemdCgroup = false'
        replace: 'SystemdCgroup = true'

    - name: Configure containerd CNI conf dir
      replace:
        path: /etc/containerd/config.toml
        regexp: 'cni_conf_dir = ""'
        replace: 'cni_conf_dir = "/etc/cni/net.d"'

    - name: Configure containerd CNI bin dir
      replace:
        path: /etc/containerd/config.toml
        regexp: 'cni_bin_dir = ""'
        replace: 'cni_bin_dir = "/opt/cni/bin"'

    - name: Restart containerd
      systemd:
        name: containerd
        state: restarted
        enabled: true

    ############################
    # Kubernetes repo (NO HANG)
    ############################
    - name: Ensure keyrings dir exists
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Download Kubernetes Release key
      command: >
        curl -fsSL --connect-timeout 10 --max-time 30
        https://pkgs.k8s.io/core:/stable:/{{ k8s_version_minor }}/deb/Release.key
        -o /etc/apt/keyrings/kubernetes-apt-keyring.key
      args:
        creates: /etc/apt/keyrings/kubernetes-apt-keyring.key

    - name: Dearmor Kubernetes key
      command: >
        gpg --batch --yes --dearmor
        -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
        /etc/apt/keyrings/kubernetes-apt-keyring.key
      args:
        creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

    - name: Add Kubernetes apt repo
      copy:
        dest: /etc/apt/sources.list.d/kubernetes.list
        content: |
          deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/{{ k8s_version_minor }}/deb/ /

    - name: Install kubelet, kubeadm, kubectl
      apt:
        update_cache: true
        name:
          - kubelet
          - kubeadm
          - kubectl
        state: present

    - name: Hold Kubernetes packages
      command: apt-mark hold kubelet kubeadm kubectl
      changed_when: false

    - name: Enable kubelet
      systemd:
        name: kubelet
        enabled: true
        state: started


############################
# MASTER
############################
- name: Init control-plane
  hosts: master
  become: true
  tasks:
    - name: Check if cluster already initialized
      stat:
        path: /etc/kubernetes/admin.conf
      register: adminconf

    - name: Render kubeadm config
      template:
        src: templates/kubeadm-config.yaml.j2
        dest: /root/kubeadm-config.yaml
      when: not adminconf.stat.exists

    - name: kubeadm init
      command: kubeadm init --config /root/kubeadm-config.yaml
      when: not adminconf.stat.exists

    - name: Setup kubeconfig for root
      shell: |
        mkdir -p /root/.kube
        cp /etc/kubernetes/admin.conf /root/.kube/config
      args:
        executable: /bin/bash

    - name: Install Flannel CNI
      command: kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Get join command
      command: kubeadm token create --print-join-command
      register: join_cmd
      changed_when: false

    - name: Save join command
      set_fact:
        kubeadm_join_command: "{{ join_cmd.stdout }}"


############################
# WORKERS
############################
- name: Join workers
  hosts: workers
  become: true
  tasks:
    - name: Check if worker already joined
      stat:
        path: /etc/kubernetes/kubelet.conf
      register: kubeletconf

    - name: Join cluster
      command: "{{ hostvars[groups['master'][0]].kubeadm_join_command }}"
      when: not kubeletconf.stat.exists


############################
# FETCH KUBECONFIG
############################
- name: Fetch kubeconfig to local machine
  hosts: master
  become: true
  tasks:
    - name: Fetch admin.conf
      fetch:
        src: /etc/kubernetes/admin.conf
        dest: "{{ playbook_dir }}/kubeconfig/admin.conf"
        flat: true
- name: Install kubeconfig locally
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tasks:
    - name: Ensure ~/.kube exists
      file:
        path: "{{ lookup('env','HOME') }}/.kube"
        state: directory
        mode: "0700"

    - name: Copy kubeconfig to ~/.kube
      copy:
        src: kubeconfig/admin.conf
        dest: "{{ lookup('env','HOME') }}/.kube/k8s-lab.conf"
        mode: "0600"

    - name: Export KUBECONFIG in shell profile
      lineinfile:
        path: "{{ lookup('env','HOME') }}/.zshrc"
        line: 'export KUBECONFIG=$HOME/.kube/k8s-lab.conf'
        create: yes

    - name: Point kubeconfig to master public IP
      command: >
        kubectl config set-cluster kubernetes
        --server=https://{{ hostvars[groups['master'][0]].ansible_host }}:6443
        --kubeconfig {{ lookup('env','HOME') }}/.kube/k8s-lab.conf